<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Availability</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f9f9f9;
            color: #333;
        }
        h1 { color: #2c3e50; }
        h2 { color: #34495e; }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        th {
            background-color: #34495e;
            color: white;
        }
        tr:nth-child(even) { background-color: #f2f2f2; }
        tr:hover { background-color: #e0e0e0; }
        button {
            margin: 5px;
            padding: 10px 15px;
            background-color: #2c3e50;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover { background-color: #34495e; }
        select {
            margin: 5px;
            padding: 10px;
            border-radius: 4px;
        }
        .section { margin-bottom: 30px; }
    </style>
</head>
<body>
    <h1>Teacher Availability</h1>

    <div class="section">
        <h2>Available Right Now</h2>
        <div id="availability">Loading schedule...</div>
    </div>

    <div class="section">
        <h2>Extra Worked Minutes</h2>
        <p>This data is stored in your local browser. Use the Export/Import buttons to back it up or restore it.</p>
        <button onclick="exportData()">Export Data</button>
        <button onclick="importData()">Import Data</button>
        <input type="file" id="importFile" style="display: none;" onchange="handleImport(event)">

        <h3>Monthly Totals</h3>
        <p>2025</p>
        <label>Select a month to see the total:</label>
        <select id="monthSelect" onchange="updateMonthlyTotal()">
            <option value="01">January</option>
            <option value="02">February</option>
            <option value="03">March</option>
            <option value="04">April</option>
            <option value="05">May</option>
            <option value="06">June</option>
            <option value="07">July</option>
            <option value="08">August</option>
            <option value="09">September</option>
            <option value="10">October</option>
            <option value="11">November</option>
            <option value="12">December</option>
        </select>
        <div id="monthlyTotal">0 minutes</div>
    </div>

    <div class="section">
        <h3>Detailed Log</h3>
        <table id="logTable">
            <thead>
                <tr>
                    <th>Teacher</th>
                    <th>Week</th>
                    <th>Minutes</th>
                </tr>
            </thead>
            <tbody>
                <!-- Rows populated by JS -->
            </tbody>
        </table>
        <button onclick="addSampleEntry()">Add Sample Entry</button>
    </div>

    <script>
        console.log("Script started");
        let logData = JSON.parse(localStorage.getItem('extraMinutes')) || [];

        function loadSchedule() {
            console.log("Fetching Lektioner.txt");
            fetch('Lektioner.txt')
                .then(response => {
                    console.log("Response received:", response);
                    if (!response.ok) throw new Error('Network response was not ok');
                    return response.text();
                })
                .then(data => {
                    console.log("Data received:", data);
                    const availabilityDiv = document.getElementById('availability');
                    const lines = data.trim().split('\n');
                    if (lines.length <= 1 || lines[1].trim() === '') {
                        availabilityDiv.innerHTML = '<p>No teachers available right now.</p>';
                        return;
                    }
                    let html = '<table><thead><tr><th>Teacher</th><th>Day</th><th>Start Time</th><th>Length</th><th>Room</th></tr></thead><tbody>';
                    for (let i = 1; i < lines.length; i++) {
                        const fields = lines[i].split(',');
                        if (fields.length === 12) {
                            const [id, subject, day, starttime, length, teacher, group, room, period, experiod, inweek, exweek] = fields;
                            html += `<tr><td>${teacher.trim()}</td><td>${day.trim()}</td><td>${starttime.trim()}</td><td>${length.trim()} mins</td><td>${room.trim()}</td></tr>`;
                        }
                    }
                    html += '</tbody></table>';
                    availabilityDiv.innerHTML = html;
                })
                .catch(error => {
                    console.error("Fetch error:", error);
                    document.getElementById('availability').innerHTML = '<p>Error loading schedule. Check Lektioner.txt.</p>';
                });
        }

        function updateMonthlyTotal() {
            const month = document.getElementById('monthSelect').value;
            const total = logData
                .filter(entry => entry.month === month && entry.year === '2025')
                .reduce((sum, entry) => sum + entry.minutes, 0);
            document.getElementById('monthlyTotal').innerHTML = `${total} minutes`;
        }

        function renderLog() {
            const tbody = document.querySelector('#logTable tbody');
            tbody.innerHTML = '';
            logData.forEach(entry => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = entry.teacher;
                row.insertCell(1).textContent = entry.week;
                row.insertCell(2).textContent = entry.minutes;
            });
        }

        function exportData() {
            const dataStr = JSON.stringify(logData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extra-minutes.json';
            a.click();
        }

        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    logData = JSON.parse(e.target.result);
                    localStorage.setItem('extraMinutes', JSON.stringify(logData));
                    renderLog();
                    updateMonthlyTotal();
                    alert('Data imported!');
                };
                reader.readAsText(file);
            }
        }

        function addSampleEntry() {
            logData.push({
                teacher: 'Sample Teacher',
                week: 'Week 1',
                minutes: 30,
                month: '10', // October
                year: '2025'
            });
            localStorage.setItem('extraMinutes', JSON.stringify(logData));
            renderLog();
            updateMonthlyTotal();
        }

        window.onload = loadSchedule;
        console.log("Initial render");
        renderLog();
        updateMonthlyTotal();
    </script>
</body>
</html>
