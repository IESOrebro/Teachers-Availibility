<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Availability</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            color: #333; 
        }
        h1, h2, h3 { 
            color: #333; 
        }
        table { 
            border-collapse: collapse; 
            width: 100%; 
            margin-top: 10px; 
        }
        th, td { 
            border: 1px solid #ddd; 
            padding: 8px; 
            text-align: left; 
        }
        th { 
            background-color: #f5f5f5; 
        }
        button { 
            margin: 5px; 
            padding: 8px 12px; 
            background-color: #f0f0f0; 
            border: 1px solid #ddd; 
            cursor: pointer; 
        }
        button:hover { 
            background-color: #e0e0e0; 
        }
        select, input[type="time"] { 
            margin: 5px; 
            padding: 5px; 
        }
        #logTable tr.separator td { 
            border: none; 
            padding: 0; 
            height: 1px; 
            background-color: #ddd; 
        }
    </style>
</head>
<body>
    <h1>Teacher Availability</h1>

    <h2>Available Right Now</h2>
    <p>Enter time slot for substitute need:</p>
    <input type="time" id="startTime" step="900"> to <input type="time" id="endTime" step="900">
    <button onclick="checkAvailability()">Check Availability</button>
    <div id="availability">No availability checked yet.</div>

    <h2>Extra Worked Minutes</h2>
    <p>This data is stored in your local browser. Use the Export/Import buttons to back it up or restore it.</p>
    <button onclick="exportData()">Export</button>
    <button onclick="importData()">Import</button>
    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">

    <h3>Monthly Totals</h3>
    <p>2025</p>
    <p>Select a month to see the total.</p>
    <select id="monthSelect" onchange="updateMonthlyTotal()">
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
    </select>
    <div id="monthlyTotal">0 minutes</div>

    <h3>Detailed Log</h3>
    <table id="logTable">
        <thead>
            <tr>
                <th>Teacher</th>
                <th>Week</th>
                <th>Minutes</th>
            </tr>
        </thead>
        <tbody>
            <!-- Rows populated by JS -->
        </tbody>
    </table>

    <script>
        let logData = JSON.parse(localStorage.getItem('extraMinutes')) || [];
        let scheduleData = [];

        // Load schedule data from Lektioner.txt
        fetch('Lektioner.txt').then(r => r.text()).then(data => {
            const lines = data.trim().split('\n');
            for (let i = 1; i < lines.length; i++) { // Skip header
                const fields = lines[i].split(',');
                if (fields.length >= 6) {
                    scheduleData.push({
                        teacher: fields[5].trim(),
                        day: fields[2].trim(),
                        startTime: fields[3].trim(),
                        length: parseInt(fields[4].trim()) || 0
                    });
                }
            }
        }).catch(e => console.error('Error loading schedule:', e));

        // Check availability based on input time
        function checkAvailability() {
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            if (!startTime || !endTime) {
                document.getElementById('availability').innerHTML = 'Please enter both start and end times.';
                return;
            }

            const start = new Date(`2025-10-24 ${startTime}:00`);
            const end = new Date(`2025-10-24 ${endTime}:00`);
            if (end <= start) {
                document.getElementById('availability').innerHTML = 'End time must be after start time.';
                return;
            }

            const availableTeachers = new Set(scheduleData.map(s => s.teacher)); // Start with all teachers
            scheduleData.forEach(entry => {
                const classStart = new Date(`2025-10-24 ${entry.startTime}:00`);
                const classEnd = new Date(classStart.getTime() + entry.length * 60000); // Convert minutes to ms

                if (entry.day === 'Friday' && // Assuming today is Friday, October 24, 2025
                    ((start >= classStart && start < classEnd) || (end > classStart && end <= classEnd) || 
                     (start <= classStart && end >= classEnd))) {
                    availableTeachers.delete(entry.teacher);
                }
            });

            const availabilityDiv = document.getElementById('availability');
            if (availableTeachers.size === 0) {
                availabilityDiv.innerHTML = 'No teachers available for this time slot.';
            } else {
                availabilityDiv.innerHTML = '<ul><li>' + Array.from(availableTeachers).join('</li><li>') + '</li></ul>';
            }
        }

        // Update monthly total
        function updateMonthlyTotal() {
            const month = document.getElementById('monthSelect').value;
            const total = logData
                .filter(entry => entry.month === month && entry.year === '2025')
                .reduce((sum, entry) => sum + entry.minutes, 0);
            document.getElementById('monthlyTotal').innerHTML = `${total} minutes`;
        }

        // Populate log table
        function renderLog() {
            const tbody = document.querySelector('#logTable tbody');
            tbody.innerHTML = '';
            logData.forEach(entry => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = entry.teacher;
                row.insertCell(1).textContent = entry.week;
                row.insertCell(2).textContent = entry.minutes;
            });
            // Add separator row
            const sepRow = tbody.insertRow();
            const sepCell = sepRow.insertCell(0);
            sepCell.colSpan = 3;
            sepCell.className = 'separator';
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(logData, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extra-minutes.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import data
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        logData = JSON.parse(e.target.result);
                        localStorage.setItem('extraMinutes', JSON.stringify(logData));
                        renderLog();
                        updateMonthlyTotal();
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Invalid file format. Please use a JSON file.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initial render
        renderLog();
        updateMonthlyTotal();
    </script>
</body>
</html>
