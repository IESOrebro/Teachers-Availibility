<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Substitute Coordinator</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            color: #333;
        }
        h1, h2, h3 {
            color: #333;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f5f5f5;
        }
        button {
            margin: 5px;
            padding: 8px 12px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            cursor: pointer;
        }
        button:hover {
            background-color: #e0e0e0;
        }
        select, input[type="time"] {
            margin: 5px;
            padding: 5px;
        }
        #logTable tr.separator td {
            border: none;
            padding: 0;
            height: 1px;
            background-color: #ddd;
        }
        .input-group {
            margin-bottom: 10px;
        }
        .error {
            color: red;
        }
        #fetchStatus {
            margin-top: 10px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Substitute Coordinator</h1>
    <div id="fetchStatus">Loading schedule...</div>

    <h2>Find Available Teachers</h2>
    <div class="input-group">
        <label for="daySelect">Select Day:</label>
        <select id="daySelect">
            <option value="Monday">Monday</option>
            <option value="Tuesday">Tuesday</option>
            <option value="Wednesday">Wednesday</option>
            <option value="Thursday">Thursday</option>
            <option value="Friday">Friday</option>
        </select>
        <label>Time Slot:</label>
        <input type="time" id="startTime" step="900"> to <input type="time" id="endTime" step="900">
        <button onclick="checkAvailability()">Check Availability</button>
    </div>
    <h3>Available Teachers</h3>
    <table id="availabilityTable">
        <thead>
            <tr>
                <th>Teacher</th>
                <th>Available Slots</th>
                <th>Action</th>
            </tr>
        </thead>
        <tbody>
            <!-- Populated by JS -->
        </tbody>
    </table>

    <h2>Extra Worked Minutes</h2>
    <p>Data is stored in your browser. Use Export/Import to back up or restore.</p>
    <button onclick="exportData()">Export</button>
    <button onclick="importData()">Import</button>
    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="handleImport(event)">

    <h3>Monthly Totals</h3>
    <p>2025</p>
    <select id="monthSelect" onchange="updateMonthlyTotal()">
        <option value="01">January</option>
        <option value="02">February</option>
        <option value="03">March</option>
        <option value="04">April</option>
        <option value="05">May</option>
        <option value="06">June</option>
        <option value="07">July</option>
        <option value="08">August</option>
        <option value="09">September</option>
        <option value="10" selected>October</option>
        <option value="11">November</option>
        <option value="12">December</option>
    </select>
    <div id="monthlyTotal">0 minutes</div>

    <h3>Detailed Log</h3>
    <table id="logTable">
        <thead>
            <tr>
                <th>Teacher</th>
                <th>Day</th>
                <th>Time Slot</th>
                <th>Minutes</th>
                <th>Week</th>
                <th>Month</th>
            </tr>
        </thead>
        <tbody>
            <!-- Populated by JS -->
        </tbody>
    </table>

    <script>
        let logData = JSON.parse(localStorage.getItem('extraMinutes')) || [];
        let scheduleData = [];

        // Replace with your GitHub raw URL for Lektioner.txt
        const scheduleUrl = 'https://raw.githubusercontent.com/your-repo/your-file/Lektioner.txt';

        // Fallback schedule data (from provided Lektioner.txt content)
        const fallbackSchedule = `Teacher                        Monday                     Tuesday                    Wednesday                  Thursday                   Friday
Agnes Hellvig                 Check schedule when needed -                        -                          -                          -
Alan Smith                    -;13:35-14:50             -;9:20-10:30              -                          -                          -
Alex Reid                     -                          9:00-10:00;13:20-         -                          10:55-12:15               -
Alvinda Hall                  9:35-10:45;13:40-14:40   -                          12:35-14:00               9:00-10:20                -
Alyssa Gestrinius             10:30-11:30               -                          -                          -                          -
Amanda Bergström              -;14:45-16:00             -                          -;12:50-14:30             -                          -
Amra Zaklan                   -                          10:15-11:25               -                          -                          -
Angelica Norgren              check schedule             check schedule             check schedule             check schedule             check schedule
Ann-Sofie Nordbrandt          9:55-10:55                -;13:05-15:00             10:30-11:45               -                          -
Anna Svensson                 9:50-12:10                8:00-10:55                8:00-9:50                 9:45-10:55                -
Carl Ölvstam                  -;12:30-13:55             8:00-11:00;13:30-14:30    10:55-12:00               -;13:30-14:30             -
Caroline Kohl                 -;12:05-13:20             -                          10:30-11:30               -                          -
Catherine Asp                 8:45-10:00                -                          -;11:00-12:45             -                          -
Dag Mollestam                 10:25-11:25;13:15-14:15  -                          -;13:15-14:30             8:00-9:20                 -
Dane Söderkvist               8:00-9:10                 -;13:25-14:25             9:20-10:30                -                          -
Elyssa Fors                   8:45-10:05;13:55-15:00   -;13:40-15:00             -;11:35-12:50             -;13:50-15:30             -
Fiona Olsson                  9:20-10:20                -;13:30-16:00             9:20-10:30;13:15-         9:25-11:20                -
Garret Cooke                  any of his support times  any of his support times  any of his support times  any of his support times  any of his support times
Hanna Ohlsson                 9:20-11:00;14:25-15:30   9:15-11:00                -;13:20-14:30             9:20-10:30                -
Jessica Erke                  8:00-9:50;11:00-12:05    8:10-10:25                10:20-11:35               -;8:00-9:20               -
Jo-Anne Wong                  -                          -                          -;12:50-                  9:20-10:40                -
Johan Anselmius               9:50-11:00                -;15:00-16:00             9:20-10:25                -                          -
Jon Hammar                    -                          8:15-9:15                 9:00-11:05                8:15-9:30                 8:00-9:15
Juan Ruiz                     Check his schedule, doesn't work everyday -;12:50-14:35 -;12:30-13:35 - -
Kayley Scrooby                -;12:45-14:20             -                          9:50-11:05                -                          -
Kevin Belyea                  -;14:50-16:00             9:20-11:40                -;12:00-13:40             8:00-9:15                 -
Kristoffer Sjöberg            8:45-10:05;13:05-14:05   -;12:10-13:45             11:15-12:35               9:40-10:50;-              8:00-9:40
Lethea McCann                 -                          9:20-11:25;12:40-14:50   -;13:05-14:40             9:15-10:25                -
Linda Nordh                   -                          -                          -                          -                          -
Linda Palmkvist               8:50-9:50                 -                          -;12:50-13:55             -                          -
Lisa Lonergan                 -;12:40-14:35             9:20-10:35                9:35-10:55                9:20-11:15;-              -;12:00-14:45
Michaela Japec                -                          9:15-11:45                10:30-11:45               8:00-9:45                 -
Naomi Kirkvold                9:20-10:30;13:35-14:40   9:20-10:40                -;12:15-13:25             9:15-10:25                -
Niclas Andersson              -                          -;13:40-14:30             9:00-10:20                -;14:00-15:50             -
Nina Easy Palm                -                          -;12:25-13:25             -;12:40-13:40             -                          -;??
Patricio Caro Gonzalez        -                          -                          10:50-11:50               -                          -
Susanne Lundkvist             9:25-10:30                -;12:30-14:35             9:20-10:30                -;12:05-13:30             -
Tekla Alsbjer                 -;14:10-15:15             9:20-10:25                8:00-9:15                 -;14:40-15:45             9:15-10:30
Tilde Lidner                  9:50-11:05;12:20-13:30   9:20-10:25                12:00-13:35               -;11:55-13:30             -
Timothy Parcel                -;13:15-14:45             -                          -;13:15-                  8:00-9:45                 -
Wynonah Plattner              Check her schedule         -                          -                          -                          -
Yoni Olsson                   -;12:20-14:00             9:15-10:20;14:50-16:00    8:00-9:15                 13:00-14:30               -
Zlatan Jaranovic              10:55-12:00               8:00-9:15                 8:00-9:30                 -                          -
Zofia Czarnowska              -                          -;14:45-16:00             11:20-12:30               11:20-12:35;14:30-16:00   9:20-10:30`;

        // Load schedule from GitHub or use fallback
        function loadSchedule() {
            const statusDiv = document.getElementById('fetchStatus');
            fetch(scheduleUrl)
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error ${response.status}`);
                    return response.text();
                })
                .then(data => {
                    statusDiv.textContent = 'Schedule loaded successfully.';
                    parseSchedule(data);
                })
                .catch(error => {
                    console.error('Error loading schedule:', error);
                    statusDiv.textContent = 'Failed to load schedule from GitHub. Using fallback data.';
                    parseSchedule(fallbackSchedule);
                });
        }

        // Parse schedule data
        function parseSchedule(data) {
            scheduleData = [];
            const lines = data.trim().split('\n');
            const headers = lines[0].split('\t').map(h => h.trim());
            for (let i = 1; i < lines.length; i++) {
                const fields = lines[i].split('\t').map(f => f.trim());
                if (fields.length >= 6) {
                    scheduleData.push({
                        teacher: fields[0],
                        Monday: fields[1],
                        Tuesday: fields[2],
                        Wednesday: fields[3],
                        Thursday: fields[4],
                        Friday: fields[5]
                    });
                }
            }
        }

        // Parse time in 24-hour format (e.g., "13:35") to minutes since midnight
        function parseTime(timeStr) {
            if (!timeStr || timeStr === '-' || timeStr === '??') return null;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        // Check if two time slots overlap
        function isOverlap(start1, end1, start2, end2) {
            return start1 < end2 && start2 < end1;
        }

        // Check availability for a given day and time slot
        function checkAvailability() {
            const day = document.getElementById('daySelect').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            const tbody = document.querySelector('#availabilityTable tbody');
            tbody.innerHTML = '';

            if (!startTime || !endTime) {
                tbody.innerHTML = '<tr><td colspan="3" class="error">Please enter both start and end times.</td></tr>';
                return;
            }

            const startMinutes = parseTime(startTime);
            const endMinutes = parseTime(endTime);
            if (endMinutes <= startMinutes) {
                tbody.innerHTML = '<tr><td colspan="3" class="error">End time must be after start time.</td></tr>';
                return;
            }

            const availableTeachers = [];
            scheduleData.forEach(entry => {
                const slots = entry[day].split(';').filter(s => s !== '-' && s !== '??');
                let isAvailable = true;
                let slotText = entry[day];

                // Handle special cases (notes)
                if (slotText.includes('check schedule') || slotText.includes('any of his support times') || slotText === '-') {
                    availableTeachers.push({ teacher: entry.teacher, slots: slotText });
                    return;
                }

                // Check for overlaps with scheduled slots
                for (const slot of slots) {
                    if (!slot.includes('-')) continue; // Skip incomplete slots like "13:20-"
                    const [slotStart, slotEnd] = slot.split('-').map(parseTime);
                    if (slotStart === null || slotEnd === null) continue;
                    if (isOverlap(startMinutes, endMinutes, slotStart, slotEnd)) {
                        isAvailable = false;
                        break;
                    }
                }

                if (isAvailable) {
                    availableTeachers.push({ teacher: entry.teacher, slots: slotText });
                }
            });

            if (availableTeachers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">No teachers available for this time slot.</td></tr>';
            } else {
                availableTeachers.forEach(({ teacher, slots }) => {
                    const row = tbody.insertRow();
                    row.insertCell(0).textContent = teacher;
                    row.insertCell(1).textContent = slots === '-' ? 'No scheduled classes' : slots === '??' ? 'Check availability' : slots;
                    const actionCell = row.insertCell(2);
                    const assignButton = document.createElement('button');
                    assignButton.textContent = 'Assign';
                    assignButton.onclick = () => assignSubstitute(teacher, day, startTime, endTime);
                    actionCell.appendChild(assignButton);
                });
            }
        }

        // Assign a substitute and log the minutes
        function assignSubstitute(teacher, day, startTime, endTime) {
            const startMinutes = parseTime(startTime);
            const endMinutes = parseTime(endTime);
            const minutes = endMinutes - startMinutes;
            const today = new Date('2025-10-26');
            // Approximate ISO week number
            const firstDayOfYear = new Date(today.getFullYear(), 0, 1);
            const pastDaysOfYear = (today - firstDayOfYear) / 86400000;
            const week = Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);
            const month = ('0' + (today.getMonth() + 1)).slice(-2);
            const year = today.getFullYear().toString();

            logData.push({
                teacher,
                day,
                timeSlot: `${startTime}-${endTime}`,
                minutes,
                week: week.toString().padStart(2, '0'),
                month,
                year
            });

            localStorage.setItem('extraMinutes', JSON.stringify(logData));
            renderLog();
            updateMonthlyTotal();
            alert(`${teacher} assigned as substitute for ${day} ${startTime}-${endTime} (${minutes} minutes).`);
        }

        // Update monthly total
        function updateMonthlyTotal() {
            const month = document.getElementById('monthSelect').value;
            const total = logData
                .filter(entry => entry.month === month && entry.year === '2025')
                .reduce((sum, entry) => sum + entry.minutes, 0);
            document.getElementById('monthlyTotal').innerHTML = `${total} minutes`;
        }

        // Populate log table
        function renderLog() {
            const tbody = document.querySelector('#logTable tbody');
            tbody.innerHTML = '';
            logData.forEach(entry => {
                const row = tbody.insertRow();
                row.insertCell(0).textContent = entry.teacher;
                row.insertCell(1).textContent = entry.day;
                row.insertCell(2).textContent = entry.timeSlot;
                row.insertCell(3).textContent = entry.minutes;
                row.insertCell(4).textContent = entry.week;
                row.insertCell(5).textContent = entry.month;
            });
            const sepRow = tbody.insertRow();
            const sepCell = sepRow.insertCell(0);
            sepCell.colSpan = 6;
            sepCell.className = 'separator';
        }

        // Export data
        function exportData() {
            const dataStr = JSON.stringify(logData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'extra-minutes.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Import data
        function importData() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        logData = JSON.parse(e.target.result);
                        localStorage.setItem('extraMinutes', JSON.stringify(logData));
                        renderLog();
                        updateMonthlyTotal();
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Invalid file format. Please use a JSON file.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Initial setup
        loadSchedule();
        renderLog();
        updateMonthlyTotal();
    </script>
</body>
</html>
